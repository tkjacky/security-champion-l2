<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Customer Login - SecBooks</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .login-container {
            max-width: 450px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: white;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header .logo {
            font-size: 2.5rem;
            color: #007bff;
            margin-bottom: 10px;
        }
        .benefits-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="bg-light">

<!-- Include navigation fragment -->
<div th:replace="~{fragments/topnav :: topnav}"></div>

<div class="container">
    <!-- FIXED: API Configuration Data Attributes using proper Thymeleaf URL expressions -->
    <div id="apiConfig" style="display: none;"
         th:data-login-url="@{/login}"
         th:data-users-url="@{/users}"
         th:data-books-url="@{/books}"
         th:data-cart-url="@{/cart}"
         th:data-checkout-url="@{/checkout}"
         th:data-api-users="@{/api/users}"
         th:data-api-cart="@{/api/cart}"
         th:data-api-profile="@{/api/profile}"
         th:data-api-auth-login="@{/api/auth/login}">
    </div>
    
    <div class="login-container">
        <div class="login-header">
            <div class="logo">B</div>
            <h2>Welcome Back!</h2>
            <p class="text-muted">Sign in to your SecBooks account</p>
        </div>

        <!-- Login Form -->
        <form id="loginForm">
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" 
                       placeholder="Enter your email address" required>
            </div>
            
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" 
                       placeholder="Enter your password" required>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="remember" name="remember">
                <label class="form-check-label" for="remember">
                    Remember me for 30 days
                </label>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg">
                    ðŸ”“ Sign In to SecBooks
                </button>
            </div>
        </form>

        <!-- Error Messages -->
        <p class="text-danger mt-3 text-center" id="errorText"></p>

        <!-- Forgot Password -->
        <div class="text-center mt-3">
            <a th:href="@{/forgot-password}" class="text-decoration-none">
                Forgot your password?
            </a>
        </div>

        <!-- New Customer -->
        <div class="text-center mt-4">
            <p class="mb-2">New to SecBooks?</p>
            <a th:href="@{/register}" class="btn btn-outline-success">
                Create Account
            </a>
        </div>

        <!-- Member Benefits -->
        <div class="benefits-card">
            <h6>ðŸŒŸ Member Benefits:</h6>
            <ul class="small mb-0">
                <li>Access to exclusive book previews</li>
                <li>Free shipping on orders over $25</li>
                <li>Personalized book recommendations</li>
                <li>Member-only discounts and deals</li>
                <li>Digital library access</li>
            </ul>
        </div>

        <!-- Demo Account Info -->
        <div class="alert alert-info mt-3">
            <h6>Demo Accounts (for testing):</h6>
            <small>
                <strong>Customer:</strong> alice@secchamp.com / password123<br>
                <strong>Staff:</strong> admin@secchamp.com / admin123<br>
                <strong>Manager:</strong> test@secchamp.com / test123
            </small>
        </div>

        <!-- Security Note -->
        <div class="text-center mt-3">
            <small class="text-muted">
                Your information is protected with industry-standard security
            </small>
        </div>
    </div>
</div>

<footer class="bg-dark text-light mt-5 py-4">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <h5>SecBooks</h5>
                <p>Your trusted online bookstore since 2020</p>
            </div>
            <div class="col-md-4">
                <h5>Customer Support</h5>
                <p>1-800-SEC-BOOK<br>
                   support@secbooks.com<br>
                   Live chat available 24/7</p>
            </div>
            <div class="col-md-4">
                <h5>Quick Links</h5>
                <a th:href="@{/help}" class="text-light d-block">Help Center</a>
                <a th:href="@{/shipping}" class="text-light d-block">Shipping Info</a>
                <a th:href="@{/returns}" class="text-light d-block">Returns & Exchanges</a>
                <a th:href="@{/privacy}" class="text-light d-block">Privacy Policy</a>
            </div>
        </div>
        <hr class="my-4">
        <div class="text-center">
            <p>&copy; 2024 SecBooks Online. All rights reserved. | Made for book lovers</p>
        </div>
    </div>
</footer>

<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script>
    // FIXED: Check if user is already authenticated with a valid token
    function checkAuthStatus() {
        const token = localStorage.getItem("authToken");
        if (token) {
            // Get URLs from data attributes
            const apiConfig = $('#apiConfig');
            const usersApiUrl = apiConfig.data('api-users');
            const usersUrl = apiConfig.data('users-url');
            
            // Validate token by making a test API call
            $.ajax({
                url: usersApiUrl,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(response) {
                    // Token is valid, redirect to users page using Thymeleaf URL
                    window.location.href = usersUrl;
                },
                error: function(xhr) {
                    // Token is invalid/expired, remove it and stay on login page
                    localStorage.removeItem("authToken");
                    console.log("Invalid/expired token removed");
                }
            });
        }
    }

    // Check auth status when page loads
    checkAuthStatus();
    
    // Check if coming from registration and clear any old tokens
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('registered') === 'true') {
        localStorage.removeItem("authToken");
        // Show a welcome message for new registration
        $('#successDiv').show();
        $('#successText').text('Registration successful! Please log in with your new account.');
        
        // Clean up URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }

    $('#loginForm').on('submit', function (e) {
        e.preventDefault();
        const email = $('#email').val();
        const password = $('#password').val();
        
        // Clear any previous error messages
        $('#errorText').text('');

        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('ðŸ”„ Signing in...').prop('disabled', true);

        // FIXED: Get URLs from data attributes
        const apiConfig = $('#apiConfig');
        const loginApiUrl = apiConfig.data('api-auth-login');
        const usersUrl = apiConfig.data('users-url');

        $.ajax({
            url: loginApiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ email, password }),
            success: function (response) {
                localStorage.setItem('authToken', response.token);
                $('#errorText').removeClass('text-danger').addClass('text-success')
                    .text('âœ… Login successful! Redirecting to your dashboard...');
                setTimeout(() => {
                    window.location.href = usersUrl;
                }, 1000);
            },
            error: function (xhr) {
                const msg = xhr.responseJSON?.error || 'Login failed. Please check your credentials.';
                $('#errorText').removeClass('text-success').addClass('text-danger')
                    .text('Error: ' + msg);
                
                // Reset button
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
</script>
<!-- Include navigation script fragment -->
<div th:replace="~{fragments/topnav :: topnav-script}"></div>
</body>
</html>
