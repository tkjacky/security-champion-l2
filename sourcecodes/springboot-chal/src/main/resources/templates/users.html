<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Library - SecBooks</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script th:src="@{/js/jquery.min.js}"></script>
    <style>
        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .book-card {
            transition: transform 0.2s;
        }
        .book-card:hover {
            transform: translateY(-5px);
        }
        .welcome-section {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .quick-action-btn {
            border-radius: 25px;
            padding: 10px 25px;
            margin: 5px;
        }
        .sidebar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        .profile-section {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .book-cover-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .book-cover-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%),
                        linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        .book-cover-large {
            height: 200px;
            width: 140px;
            font-size: 18px;
        }
        .book-cover-small {
            height: 80px;
            width: 60px;
            font-size: 12px;
        }
        .book-cover-placeholder .book-icon {
            font-size: 1.5em;
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-light">

<!-- FIXED: API Configuration Data Attributes using proper Thymeleaf URL expressions -->
<div id="apiConfig" style="display: none;"
        th:data-login-url="@{/login}"
        th:data-users-url="@{/users}"
        th:data-books-url="@{/books}"
        th:data-cart-url="@{/cart}"
        th:data-checkout-url="@{/checkout}"
        th:data-api-users="@{/api/users}"
        th:data-api-cart="@{/api/cart}"
        th:data-api-profile="@{/api/profile}"
        th:data-api-auth-login="@{/api/auth/login}"
        th:data-api-auth-register="@{/api/auth/register}"
        th:data-api-user-books-with-quantities="@{/api/user/books-with-quantities}"
        th:data-api-sms-send="@{/api/sms/send}">
</div>

<!-- Include navigation fragment -->
<div th:replace="~{fragments/topnav :: topnav}"></div>

<div class="container mt-4" id="contentContainer" style="display: none;">
    
    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>Welcome to Your Library!</h1>
                <p class="lead mb-3">Discover, read, and manage your book collection</p>
                <div>
                    <a th:href="@{/books}" class="btn btn-light quick-action-btn">Browse Books</a>
                    <a th:href="@{/advanced_search}" class="btn btn-light quick-action-btn">Advanced Search</a>
                    <a th:href="@{/help}" class="btn btn-light quick-action-btn">Help</a>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="h1">B</div>
                <p>Happy Reading!</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8">
            
            <!-- Reading Statistics -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card dashboard-card stats-card">
                        <div class="card-body text-center">
                            <h3 id="total-books-owned">0</h3>
                            <p class="mb-0">Books Owned</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dashboard-card stats-card">
                        <div class="card-body text-center">
                            <h3 id="user-credit-display">$0.00</h3>
                            <p class="mb-0">Credit Limit</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dashboard-card stats-card">
                        <div class="card-body text-center">
                            <h3 id="recent-purchases">0</h3>
                            <p class="mb-0">Recent Purchases</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currently Reading -->
            <div class="card dashboard-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Currently Reading</h5>
                </div>
                <div class="card-body">
                    <div th:if="${currentlyReading != null and !currentlyReading.isEmpty()}">
                        <div th:each="book, iterStat : ${currentlyReading}" th:if="${iterStat.index == 0}" class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="book-cover-placeholder book-cover-large mx-auto">
                                        <div class="book-icon">
                                            <i class="fas fa-book"></i><br>
                                            <small th:text="${#strings.length(book.title) > 15 ? #strings.substring(book.title, 0, 15) + '...' : book.title}">Book Title</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <h6 th:text="${book.title}">Book Title</h6>
                                <p class="text-muted" th:text="'by ' + ${book.author}">by Author</p>
                                <div class="progress mb-2">
                                    <div class="progress-bar" style="width: 65%"></div>
                                </div>
                                <p class="small">65% complete ‚Ä¢ Page 234 of 360</p>
                                <a th:href="'/books?search=' + ${book.title}" class="btn btn-primary btn-sm">Continue Reading</a>
                                <p class="small mt-2 text-muted" th:if="${book.description}" th:text="${#strings.length(book.description) > 100 ? #strings.substring(book.description, 0, 100) + '...' : book.description}">Book description</p>
                            </div>
                        </div>
                    </div>
                    <div th:if="${currentlyReading == null or currentlyReading.isEmpty()}" class="text-center text-muted">
                        <p>You haven't started reading any books yet. <a th:href="@{/books}" class="text-primary">Browse our collection</a> to get started!</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card dashboard-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Reading Activity</h5>
                </div>
                <div class="card-body">
                    <div th:if="${recentActivityBooks != null and !recentActivityBooks.isEmpty()}">
                        <div th:each="book, iterStat : ${recentActivityBooks}" th:if="${iterStat.index < 4}" class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span th:switch="${iterStat.index}">
                                    <span th:case="0" th:text="|Completed &quot;${book.title}&quot;|">Completed Book</span>
                                    <span th:case="1" th:text="|Rated &quot;${book.title}&quot; - ${book.rating != null ? book.rating + ' stars' : '5 stars'}|">Rated Book</span>
                                    <span th:case="2" th:text="|Added &quot;${book.title}&quot; to wishlist|">Added to wishlist</span>
                                    <span th:case="*" th:text="|Started reading &quot;${book.title}&quot;|">Started reading</span>
                                </span>
                                <small class="text-muted" th:switch="${iterStat.index}">
                                    <small th:case="0">2 days ago</small>
                                    <small th:case="1">1 week ago</small>
                                    <small th:case="2">2 weeks ago</small>
                                    <small th:case="*">1 month ago</small>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div th:if="${recentActivityBooks == null or recentActivityBooks.isEmpty()}" class="text-center text-muted">
                        <p>No recent reading activity. Start reading to see your activity here!</p>
                    </div>
                </div>
            </div>

            <!-- My Books -->
            <div class="card dashboard-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">My Books</h5>
                </div>
                <div class="card-body">
                    <div id="ownedBooksContainer">
                        <div class="text-center text-muted">
                            <p>Loading your books...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            
            <!-- Profile Section -->
            <div class="profile-section mb-4">
                <div class="h1 text-primary">U</div>
                <h6 id="profileName">Loading...</h6>
                <p class="text-muted small" id="profileEmail">Loading...</p>
                <a th:href="@{/profile}" class="btn btn-outline-primary btn-sm">Edit Profile</a>
            </div>

            <!-- Account Status Section -->
            <div class="card dashboard-card mb-4" id="accountStatusCard">
                <div class="card-header" id="statusHeader">
                    <h6 class="mb-0">Account Status</h6>
                </div>
                <div class="card-body">
                    <div id="statusContent">
                        <p class="mb-2">Status: <span id="accountStatus" class="badge">Loading...</span></p>
                        <p class="mb-2">Credit Limit: <span id="creditLimit">Loading...</span></p>
                        <div id="statusMessage" class="alert" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card dashboard-card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a th:href="@{/advanced_search}" class="btn btn-outline-primary btn-sm">Advanced Search</a>
                        <button class="btn btn-outline-success btn-sm" onclick="alert('Not implemented')">Purchase History</button>
                        <button class="btn btn-outline-info btn-sm" onclick="alert('Not implemented')">Download App</button>
                        <button class="btn btn-outline-warning btn-sm" onclick="alert('Not implemented')">Gift Cards</button>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="card dashboard-card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">Recommended for You</h6>
                </div>
                <div class="card-body">
                    <div th:if="${recommendedBooks != null and !recommendedBooks.isEmpty()}">
                        <div th:each="book, iterStat : ${recommendedBooks}" th:if="${iterStat.index < 3}" class="mb-3">
                            <div class="row">
                                <div class="col-4">
                                    <div class="text-center">
                                        <div class="book-cover-placeholder book-cover-small mx-auto">
                                            <div class="book-icon">üìñ</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-8">
                                    <h6 class="small mb-1" th:text="${book.title}">Book Title</h6>
                                    <p class="text-muted small mb-1" th:text="${book.author}">Author</p>
                                    <span class="badge bg-success small" 
                                          th:text="${book.rating != null ? (book.rating.doubleValue() * 20) + '% match' : '95% match'}">95% match</span>
                                    <div th:if="${book.category}" class="mt-1">
                                        <span class="badge bg-secondary small" th:text="${book.category}">Category</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a th:href="@{/books}" class="btn btn-info btn-sm w-100">View All Recommendations</a>
                    </div>
                    <div th:if="${recommendedBooks == null or recommendedBooks.isEmpty()}" class="text-center text-muted">
                        <p class="small">No recommendations available. <a th:href="@{/books}" class="text-primary">Browse books</a> to get personalized recommendations!</p>
                    </div>
                </div>
            </div>

            <!-- Staff Features (Admin Only) -->
            <div class="card dashboard-card" id="staffFeatures" style="display: none;">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">Staff Dashboard</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button id="viewCustomersBtn" class="btn btn-outline-danger btn-sm">View Customers</button>
                        <button id="sendNotificationBtn" class="btn btn-outline-warning btn-sm">Send Notifications</button>
                        <button class="btn btn-outline-info btn-sm">Sales Reports</button>
                    </div>
                </div>
            </div>

            <!-- Customer Management (Staff View) -->
            <div id="customerManagement" style="display: none;" class="mt-4">
                <div class="card dashboard-card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">Customer Management</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm" id="customerTable">
                            <thead>
                            <tr>
                                <th>Name</th><th>Email</th><th>Actions</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        
                        <div class="mt-3">
                            <label class="form-label small">Send Notification:</label>
                            <select id="smsUserSelect" class="form-select form-select-sm mb-2"></select>
                            <button id="sendSmsBtn" class="btn btn-warning btn-sm w-100">Send SMS</button>
                            <p id="smsStatus" class="mt-2 text-info small"></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

<div class="container mt-4 text-center" id="unauthContainer" style="display: none;">
    <div class="alert alert-warning">
        <h4>Access Required</h4>
        <p>Please log in to access your SecBooks library</p>
        <a th:href="@{/login}" class="btn btn-primary">Sign In</a>
    </div>
</div>

<footer class="bg-dark text-light mt-5 py-4">
    <div class="container">
        <div class="text-center">
            <p>&copy; 2024 SecBooks Online. Your personal reading companion.</p>
        </div>
    </div>
</footer>

<script>
    const authToken = localStorage.getItem("authToken");
    const apiConfig = $('#apiConfig');
    const usersApiUrl = apiConfig.data('api-users');
    const usersUrl = apiConfig.data('users-url');
    const booksQuantitleUrl = apiConfig.data('api-user-books-with-quantities');
    const smsSendUrl = apiConfig.data('api-sms-send')
    if (!authToken) {
        $("#unauthContainer").show();
    } else {
        fetch(usersApiUrl, {
            headers: {
                'Authorization': 'Bearer ' + authToken
            }
        })
        .then(response => {
            if (!response.ok) {
                localStorage.removeItem("authToken");
                $("#unauthContainer").show();
                throw new Error('Unauthorized');
            }
            return response.json();
        })
        .then(data => {
            $("#contentContainer").show();
            
            // Update profile information (page-specific)
            if (data && data.length > 0) {
                const currentUser = data[0]; // Assuming first user is current user
                $("#profileName").text(currentUser.name);
                $("#profileEmail").text(currentUser.email);
                
                // Update statistics in the dashboard cards
                $("#user-credit-display").text('$' + currentUser.creditLimit.toFixed(2));
                
                // Update account status
                updateAccountStatus(currentUser);
                
                // Load user's owned books and update statistics
                loadOwnedBooksAndStats();
                
                // Check if user is admin/staff
                if (currentUser.email.includes('admin') || currentUser.email.includes('staff')) {
                    $("#staffFeatures").show();
                }
            }

            // Populate customer table for staff
            const tbody = $("#customerTable tbody");
            const select = $("#smsUserSelect");
            tbody.empty();
            select.empty();
            
            data.forEach(user => {
                tbody.append(`
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm">View</button>
                        </td>
                    </tr>
                `);
                select.append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            $("#unauthContainer").show();
        });
    }

    // Page-specific event handlers
    $("#viewCustomersBtn").click(function() {
        $("#customerManagement").toggle();
        $(this).text($("#customerManagement").is(':visible') ? 'Hide Customers' : 'View Customers');
    });

    $("#sendSmsBtn").click(function() {
        const userId = $("#smsUserSelect").val();
        if (!userId) {
            $("#smsStatus").text("Please select a customer").removeClass("text-success").addClass("text-danger");
            return;
        }

        $.ajax({
            url: smsSendUrl,
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ userId: parseInt(userId) }),
            success: function(response) {
                $("#smsStatus").text("‚úÖ " + response.message).removeClass("text-danger").addClass("text-success");
            },
            error: function(xhr) {
                const msg = xhr.responseJSON?.error || 'Failed to send notification';
                $("#smsStatus").text("‚ùå " + msg).removeClass("text-success").addClass("text-danger");
            }
        });
    });

    // Function to update account status display
    function updateAccountStatus(user) {
        const status = user.accountStatus || 'UNKNOWN';
        const creditLimit = user.creditLimit || 0;
        
        // Update status badge
        const statusBadge = $("#accountStatus");
        const statusHeader = $("#statusHeader");
        const statusMessage = $("#statusMessage");
        
        statusBadge.text(status);
        $("#creditLimit").text('$' + creditLimit);
        
        // Set appropriate styling based on status
        statusBadge.removeClass('bg-success bg-warning bg-danger bg-secondary');
        statusHeader.removeClass('bg-success bg-warning bg-danger');
        statusMessage.hide().removeClass('alert-success alert-warning alert-danger alert-info');
        
        switch(status) {
            case 'ACTIVE':
                statusBadge.addClass('bg-success');
                statusHeader.addClass('bg-success text-white');
                statusMessage.addClass('alert-success').text('‚úÖ Your account is active and ready for purchases!').show();
                break;
            case 'PENDING':
                statusBadge.addClass('bg-warning text-dark');
                statusHeader.addClass('bg-warning text-dark');
                statusMessage.addClass('alert-warning').text('‚è≥ Your account is pending approval. Contact an administrator to activate your account before making purchases.').show();
                break;
            case 'SUSPENDED':
                statusBadge.addClass('bg-danger');
                statusHeader.addClass('bg-danger text-white');
                statusMessage.addClass('alert-danger').text('üö´ Your account has been suspended. Contact support for assistance.').show();
                break;
            default:
                statusBadge.addClass('bg-secondary');
                statusHeader.addClass('bg-secondary text-white');
                statusMessage.addClass('alert-info').text('‚ÑπÔ∏è Account status: ' + status).show();
        }
    }

    // Function to load owned books and update statistics
    function loadOwnedBooksAndStats() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            $("#ownedBooksContainer").html('<div class="text-center text-muted"><p>Please log in to view your books.</p></div>');
            return;
        }

        $.ajax({
            url: booksQuantitleUrl,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(booksWithQuantities) {
                // Calculate total books owned (sum of all quantities)
                const totalBooksOwned = booksWithQuantities.reduce((total, bookData) => total + bookData.quantity, 0);
                $("#total-books-owned").text(totalBooksOwned);
                
                // Calculate recent purchases (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const recentPurchases = booksWithQuantities.reduce((total, bookData) => {
                    const lastPurchaseDate = new Date(bookData.lastPurchaseDate);
                    return lastPurchaseDate > thirtyDaysAgo ? total + bookData.quantity : total;
                }, 0);
                $("#recent-purchases").text(recentPurchases);
                
                if (booksWithQuantities && booksWithQuantities.length > 0) {
                    let html = '<div class="row">';
                    booksWithQuantities.forEach(function(bookData, index) {
                        const book = bookData.book;
                        if (index > 0 && index % 2 === 0) {
                            html += '</div><div class="row">';
                        }
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-4">
                                                <div class="book-cover-placeholder book-cover-small">
                                                    <div class="book-icon">üìñ</div>
                                                </div>
                                            </div>
                                            <div class="col-8">
                                                <h6 class="card-title">${book.title}</h6>
                                                <p class="card-text small text-muted">by ${book.author}</p>
                                                <p class="card-text small">$${book.price}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge bg-primary">Qty: ${bookData.quantity}</span>
                                                    <small class="text-muted">
                                                        Total: $${bookData.totalSpent.toFixed(2)}
                                                    </small>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    ${bookData.quantity === 1 
                                                        ? `Purchased: ${new Date(bookData.firstPurchaseDate).toLocaleDateString()}`
                                                        : `First: ${new Date(bookData.firstPurchaseDate).toLocaleDateString()}, Latest: ${new Date(bookData.lastPurchaseDate).toLocaleDateString()}`
                                                    }
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    $("#ownedBooksContainer").html(html);
                } else {
                    $("#ownedBooksContainer").html(`
                        <div class="text-center text-muted">
                            <p>You haven't purchased any books yet.</p>
                            <a th:href="@{/books}" class="btn btn-primary btn-sm">Browse Books</a>
                        </div>
                    `);
                }
            },
            error: function(xhr) {
                console.error('Error loading owned books:', xhr);
                $("#ownedBooksContainer").html(`
                    <div class="text-center text-muted">
                        <p>Unable to load your books at this time.</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadOwnedBooksAndStats()">Try Again</button>
                    </div>
                `);
            }
        });
    }
    
    // Keep the old function for backward compatibility
    function loadOwnedBooks() {
        loadOwnedBooksAndStats();
    }
</script>
<!-- Include navigation script fragment -->
<div th:replace="~{fragments/topnav :: topnav-script}"></div>
</body>
</html>
